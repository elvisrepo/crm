accounts {
    int id PK
    string name "Required"
    string phone
    string website
    string type "Enum"
    text description
    text billing_address
    text shipping_address
    int parent_account_id FK "Self-referencing"
    int owner_id FK "Required"
    bool is_active
    int version "For optimistic locking"
}

contacts {
    int id PK
    string first_name
    string last_name "Required"
    string title
    string email
    string phone
    text description
    int reports_to_id FK "Self-referencing"
    int account_id FK "Required"
    int owner_id FK "Required"
    bool is_active
    int version "For optimistic locking"
}

leads {
    int id PK
    string first_name
    string last_name "Required"
    string company "Required"
    string title
    string email
    string phone
    string website
    text address
    string status "Enum, Required"
    string lead_source "Enum"
    string industry "Enum"
    int owner_id FK "Required"
    int version "For optimistic locking"
}

opportunities {
    int id PK
    string name "Required"
    string stage "Enum, Required"
    date close_date
    int probability "Calculated"
    text next_step
    text description
    int account_id FK "Required"
    int owner_id FK "Required"
    int version "For optimistic locking"
}

products {
    int id PK
    string name "Required"
    text description
    decimal standard_list_price
    bool is_retainer_product
    bool is_active
    int version "For optimistic locking"
}

contracts {
    int id PK
    string status "Enum: 'Draft', 'Active', 'Expired', 'Terminated'"
    date start_date
    date end_date
    string billing_cycle "Enum: 'Monthly', 'Annually'"
    int account_id FK "Required"
    int opportunity_id FK "Source opportunity"
    int version "For optimistic locking"
}

orders {
    int id PK
    date order_date
    string status "Enum"
    int account_id FK "Required"
    int opportunity_id FK "Source opportunity"
    int version "For optimistic locking"
}

invoices {
    int id PK
    int contract_id FK "Required"
    date due_date "Required"
    decimal amount_due "Required"
    string status "Enum: 'Awaiting Payment', 'Paid', 'Partially Paid', 'Overdue', 'Cancelled'"
    int version "For optimistic locking"
}

payments {
    int id PK
    decimal amount "Required"
    date payment_date "Required"
    string payment_method "Enum, Required"
    string status "Enum"
    string transaction_id
    text notes
    int order_id FK "Nullable"
    int invoice_id FK "Nullable"
    int version "For optimistic locking"
}

activities {
    int id PK
    string subject "Required"
    string description
    string type "Enum: 'Task', 'Event'"
    string status "Enum"
    string priority "Enum"
    datetime due_date "For Tasks"
    datetime start_time "For Events"
    datetime end_time "For Events"
    bool is_all_day_event
    string location
    int assigned_to_id FK "Required"
    int what_id "Polymorphic"
    string what_type "Polymorphic"
    int who_id "Polymorphic"
    string who_type "Polymorphic"
    int version "For optimistic locking"
}

opportunity_line_items {
    int id PK
    int opportunity_id FK
    int product_id FK
    int quantity
    decimal sale_price
}

order_line_items {
    int id PK
    int order_id FK
    int product_id FK
    int quantity
    decimal price_at_purchase
}

contract_line_items {
    int id PK
    int contract_id FK
    int product_id FK
    int quantity
    decimal price_per_cycle
}

opportunity_contact_roles {
    int id PK
    int opportunity_id FK
    int contact_id FK
    string role
}

%% --- Relationships ---
users ||--o{ accounts : owns
users ||--o{ contacts : owns
users ||--o{ leads : owns
users ||--o{ opportunities : owns
users ||--o{ activities : is_assigned

accounts ||--o{ contacts : has
accounts ||--o{ opportunities : has
accounts ||--o{ orders : "places"
accounts ||--o{ contracts : "holds"
accounts }o--|| accounts : "can have parent"

contacts }o--|| contacts : "reports to"

opportunities ||--o{ opportunity_line_items : contains
opportunities ||--o{ opportunity_contact_roles : involves
opportunities |o--o{ orders : "generates for one-time sales"
opportunities |o--o{ contracts : "generates for retainers"

products ||--o{ opportunity_line_items : is_in
products ||--o{ order_line_items : is_in
products ||--o{ contract_line_items : is_in

contacts ||--o{ opportunity_contact_roles : participates_in

orders ||--o{ order_line_items : contains
orders ||--o{ payments : "is paid by"

contracts ||--o{ contract_line_items : "details"
contracts ||--o{ invoices : "generates"

invoices ||--o{ payments : "is paid by"
