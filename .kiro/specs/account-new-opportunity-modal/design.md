# Design Document

## Overview

This feature adds a modal-based opportunity creation workflow to the AccountPage component. The implementation follows the same architectural pattern as the existing "New Contact" modal functionality, ensuring consistency in code structure and user experience. The design leverages existing components (OpportunityForm and Modal) and follows React Query patterns for data fetching and cache management.

## Architecture

### Component Structure

```
AccountPage (modified)
├── Modal (existing component)
│   └── OpportunityForm (existing component, enhanced)
└── State Management
    ├── isNewOpportunityModalOpen (new state)
    ├── createOpportunityMutation (new mutation)
    └── accounts query (new query for form dropdown)
```

### Data Flow

1. User clicks "New Opportunity" button → `setIsNewOpportunityModalOpen(true)`
2. Modal opens → OpportunityForm renders with pre-filled account_id
3. User fills form and submits → `createOpportunityMutation.mutate(formData)`
4. API call succeeds → Query invalidation triggers data refresh
5. Modal closes → Updated opportunities list displays in the account page

## Components and Interfaces

### AccountPage Modifications

**New State:**
```javascript
const [isNewOpportunityModalOpen, setIsNewOpportunityModalOpen] = useState(false);
```

**New Query:**
```javascript
const { data: accounts = [] } = useQuery({
    queryKey: ['accounts'],
    queryFn: getAccounts,
    enabled: isNewOpportunityModalOpen  // Only fetch when modal opens
});
```

**New Mutation:**
```javascript
const createOpportunityMutation = useMutation({
    mutationFn: (opportunityData) => {
        const dataToSubmit = {
            ...opportunityData,
            account_id: opportunityData.account_id || parseInt(id)
        };
        return createOpportunity(dataToSubmit);
    },
    onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['opportunities'] });
        queryClient.invalidateQueries({ queryKey: ['account', id] });
        setIsNewOpportunityModalOpen(false);
    },
    onError: (err) => {
        console.error('Error creating opportunity:', err);
    }
});
```

**Button Handler:**
The existing "New Opportunity" button (currently a Link) will be changed to a button:
```javascript
<button 
    onClick={() => setIsNewOpportunityModalOpen(true)} 
    className={styles.primaryButton}
>
    New Opportunity
</button>
```

**Modal JSX:**
```javascript
<Modal isOpen={isNewOpportunityModalOpen} onClose={() => setIsNewOpportunityModalOpen(false)}>
    <OpportunityForm
        onSubmit={createOpportunityMutation.mutate}
        onCancel={() => setIsNewOpportunityModalOpen(false)}
        isLoading={createOpportunityMutation.isLoading}
        error={createOpportunityMutation.error}
        accounts={accounts}
        defaultAccountId={parseInt(id)}
    />
</Modal>
```

### OpportunityForm Enhancements

The OpportunityForm component needs to be enhanced to support the `defaultAccountId` prop, similar to how NewContactForm works.

**New Prop:**
```javascript
const OpportunityForm = ({ 
    initialData, 
    onSubmit, 
    onCancel, 
    isLoading, 
    error, 
    accounts,
    defaultAccountId = null  // New prop
}) => {
```

**Form State Initialization:**
```javascript
const [formData, setFormData] = useState({
    name: '',
    account_id: defaultAccountId || '',  // Pre-fill if provided
    stage: 'prospecting',
    close_date: '',
    description: '',
    next_step: '',
});
```

**Account Dropdown Modification:**
```javascript
<select
    id="account_id"
    name="account_id"
    value={formData.account_id}
    onChange={handleChange}
    required
    disabled={defaultAccountId !== null}  // Disable if pre-filled
>
    <option value="">Select an Account</option>
    {accounts?.map(account => (
        <option key={account.id} value={account.id}>
            {account.name}
        </option>
    ))}
</select>
```

## Data Models

### Opportunity Creation Payload

```javascript
{
    name: string,           // Required
    account_id: number,     // Required, pre-filled from AccountPage
    stage: string,          // Default: 'prospecting'
    close_date: string,     // Optional, ISO date format
    description: string,    // Optional
    next_step: string       // Optional
}
```

### API Response

The `createOpportunity` API returns the created opportunity object with all fields including:
- `id`: Generated by backend
- `owner`: Automatically set to current user
- `created_at`, `updated_at`: Timestamps
- `version`: For optimistic locking

## Error Handling

### Form Validation Errors
- Required field validation handled by HTML5 `required` attribute
- Browser displays native validation messages
- Form submission blocked until valid

### API Errors
- Displayed in the OpportunityForm via the `error` prop
- Error message shown above form actions
- Submit button remains enabled to allow retry
- Example errors:
  - Network failures
  - Server validation errors (400)
  - Authentication errors (401)
  - Permission errors (403)

### Query Errors
- Accounts query failure: Form still usable if accounts already cached
- If no accounts available: User sees empty dropdown (edge case)

## Testing Strategy

### Manual Testing Checklist

1. **Modal Interaction**
   - [ ] Click "New Opportunity" button opens modal
   - [ ] Click outside modal closes it
   - [ ] Click Cancel button closes modal
   - [ ] ESC key closes modal (Modal component behavior)

2. **Form Pre-population**
   - [ ] Account field is pre-filled with current account name
   - [ ] Account dropdown is disabled
   - [ ] Other fields are empty and editable

3. **Form Submission**
   - [ ] Submit with empty name shows validation error
   - [ ] Submit with valid data creates opportunity
   - [ ] Loading state shows during submission
   - [ ] Success closes modal and refreshes data
   - [ ] New opportunity appears in Related Opportunities list

4. **Error Scenarios**
   - [ ] Network error displays error message
   - [ ] Server error displays error message
   - [ ] User can retry after error

5. **Data Consistency**
   - [ ] Created opportunity has correct account association
   - [ ] Created opportunity appears in opportunities list
   - [ ] Account page shows updated opportunity count

### Integration Points to Verify

1. **React Query Cache**
   - Verify `['opportunities']` query is invalidated
   - Verify `['account', id]` query is invalidated
   - Verify data refetches automatically

2. **API Integration**
   - Verify `createOpportunity` is called with correct payload
   - Verify account_id is included in request
   - Verify response is handled correctly

3. **Component Reusability**
   - Verify OpportunityForm works in both create and edit modes
   - Verify defaultAccountId prop doesn't break edit mode
   - Verify Modal component behavior is consistent

## Design Decisions and Rationales

### 1. Conditional Query Fetching
**Decision:** Fetch accounts only when modal opens (`enabled: isNewOpportunityModalOpen`)

**Rationale:** 
- Reduces unnecessary API calls on page load
- Accounts data is only needed when creating an opportunity
- Follows the same pattern as New Contact modal
- Improves initial page load performance

### 2. Reuse OpportunityForm Component
**Decision:** Enhance existing OpportunityForm instead of creating a new component

**Rationale:**
- Maintains consistency between create and edit flows
- Reduces code duplication
- Single source of truth for form validation and structure
- Easier to maintain and update

### 3. Disable Account Field When Pre-filled
**Decision:** Disable the account dropdown when `defaultAccountId` is provided

**Rationale:**
- Prevents user confusion about which account the opportunity belongs to
- Enforces the relationship between account and opportunity
- Matches the pattern used in NewContactForm
- Clear visual indicator that field is pre-determined

### 4. Change Button from Link to Button Element
**Decision:** Convert "New Opportunity" from `<Link>` to `<button>`

**Rationale:**
- Modal-based creation doesn't require navigation
- Keeps user on the same page for better context
- Faster workflow (no page load)
- Consistent with "New Contact" button behavior

### 5. Query Invalidation Strategy
**Decision:** Invalidate both `opportunities` and `account` queries

**Rationale:**
- `opportunities` invalidation ensures global list is updated
- `account` invalidation ensures the current page shows new opportunity
- Automatic refetch provides immediate feedback
- Prevents stale data issues

## Future Enhancements

1. **Success Toast Notification**
   - Add visual confirmation when opportunity is created
   - Display opportunity name in success message

2. **Navigate to Created Opportunity**
   - Option to navigate to the new opportunity detail page after creation
   - "Create and View" vs "Create and Close" buttons

3. **Form Field Enhancements**
   - Add amount/value field to opportunity form
   - Add probability field based on stage
   - Add expected revenue calculation

4. **Bulk Operations**
   - Create multiple opportunities at once
   - Clone existing opportunity with pre-filled data

5. **Smart Defaults**
   - Auto-populate close date based on stage
   - Suggest opportunity name based on account
   - Pre-fill owner based on account owner
